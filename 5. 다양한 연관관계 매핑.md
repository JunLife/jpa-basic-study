# 다양한 연관관계 매핑

## 목차

1. 다대일 [N:1]
2. 일대다 [1:N]
3. 일대일 [1:1]
4. 다대다 [N:N]
5. 실전 예제 3 - 다양한 연관관계 매핑

------



## 1. 다대일 [N:1]

- 단방향
  - 가장 많이 사용하는 연관관계
- 양방향
  - 외래키가 있는 쪽이 연관관계의 주인
  - 반대편은 mappedBy 적용
  - 양쪽을 서로 참조하도록 개발



## 2. 일대다 [1:N]

- 단방향
  - [1:N] 에서 1쪽이 연관관계의 주인
  - 테이블의 [1:N]는 항상 N쪽에 외래키가 있음
  - 객체와 테이블의 차이 때문에 반대편 테이블의 외래키를 관리하는 특이한 구조
  - @JoinColumn을 꼭 사용해야 함. 그렇지 않으면 조인 테이블 방식을 사용함 (중간에 테이블을 하나 추가함)
  - 연관관계 관리를 위해 추가로 UPDATE SQL이 실행됨
  - **[1:N] 단방향 매핑보다는 [N:1] 양방향 매핑을 사용하자**
- 양방향
  - 이런 매핑은 공식적으로 존재하지 않음
  - @JoinColumn(insertable = false, updatable = false)
  - 읽기 전용 필드를 사용해서 양방향처럼 사용하는 방법
  - **[N:1] 양방향 매핑을 사용하자**



## 3. 일대일 [1:1]

- [1:1] 관계는 반대도 [1:1]
- 외래키에 데이터베이스 unique 제약조건 추가
- 주 테이블이나 대상 테이블 중에 외래키 선택 가능
- 주 테이블에 외래키
  - 단방향
    - [N:1] 단방향 매핑과 유사
  - 양방향
    - 외래키가 있는 곳이 연관관계의 주인
    - 반대편은 mappedBy 적용
- 대상 테이블에 외래키
  - 단방향
    - JPA에서 지원 X
  - 양방향
    - 주 테이블에 외래키에서 양방향 매핑과 방법이 같음

### 정리

- 주 테이블에 외래키
  - 주 객체가 대상 객체의 참조를 가지는 것 처럼, 주 테이블에 외래키를 두고 대상 테이블을 찾음
  - 객체지향 개발자 선호
  - JPA 매핑 편리
  - 장점: 주 테이블만 조회해도 대상 테이블에 데이터가 있는지 확인 가능
  - 단점: 값이 없으면 외래키에 null 허용
- 대상 테이블에 외래키
  - 대상 테이블에 외래키가 존재
  - 전통적인 데이터베이스 개발자 선호
  - 장점: 주 테이블과 대상 테이블을 [1:1]에서 [1:N] 관계로 변경할 때 테이블 구조 유지
  - 단점: 프록시 기능의 한계로 **지연 로딩으로 설정해도 항상 즉시 로딩됨**



## 4. 다대다 [N:M]

- 관계형 데이터베이스는 정규화된 테이블 2개로 [N:M] 관계를 표현할 수 없음
  - 연결 테이블을 추가해서 [1:N] + [N:1] 관계로 풀어내야 함
- 객체는 컬렉션을 사용해서 객체 2개로 [N:M] 관계 가능
  - **@ManyToMany** 사용
  - **@JoinTable**로 연결 테이블 지정
  - [N:M] 매핑: 단방향, 양방향 가능

### 한계

- 편리해 보이지만 실무에서 사용 X
- 연결 테이블이 단순히 연결만 하고 끝나지 않음
- 주문시간, 수량 같은 데이터가 들어올 수 있음

### 해결 방법

- 연결 테이블용 엔티티 추가 **(연결 테이블을 엔티티로 승격)**
- @ManyToMany → @OneToMany + @ManyToOne



## 5. 실전 예제 3 - 다양한 연관관계 매핑

### 배송, 카테고리 추가

- 주문과 배송은 [1:1]

- 상품과 카테고리는 [N:M]

  ![실전_예제3_ERD.png](./image/실전_예제3_ERD.png)

### [N:M] 관계는 [1:N] + [N:1]로

- 테이블의 [N:M] 관계는 중간 테이블을 이용한다.
- 실전에서는 중간 테이블이 단순하지 않다.
- @ManyToMany의 제약: 필드 추가 불가능, 엔티티 테이블 불일치
- **실전에서는 @ManyToMany 사용 X**

### @JoinColumn

- 외래키를 매핑할 때 사용

| 속성                                     | 설명                                   | 기본값                                       |
| ---------------------------------------- | -------------------------------------- | -------------------------------------------- |
| name                                     | 매핑할 외래키 이름                     | 필드명 + _ + 참조하는 테이블의 기본키 컬럼명 |
| referenceColumnName                      | 외래키가 참조하는 대상 테이블의 컬럼명 | 참조하는 테이블의 기본키 컬럼명              |
| foreignKey (DDL)                         | 외래키 제약조건을 직접 지정할 수 있다. |                                              |
| 이 속성은 테이블을 생성할 때만 사용한다. |                                        |                                              |
| unique                                   |                                        |                                              |
| updatable, insertable                    |                                        |                                              |
| nullable                                 |                                        |                                              |
| columnDefinition                         |                                        |                                              |
| table                                    | @Column의 속성과 같다.                 |                                              |

### @ManyToOne

- 다대일 관계 매핑

| 속성                                                 | 설명                                               | 기본값                                              |
| ---------------------------------------------------- | -------------------------------------------------- | --------------------------------------------------- |
| optional                                             | false로 설정하면 연관된 엔티티가 항상 있어야 한다. | true                                                |
| fetch                                                | 글로벌 패치 전략을 설정한다.                       | @ManyToOne=FetchType.EAGER@OneToMany=FetchType.LAZY |
| cascade                                              | 영속성 전이 기능을 사용한다.                       |                                                     |
| targetEntity                                         | 연관된 엔티티의 타입 정보를 설정한다.              |                                                     |
| 이 기능은 거의 사용하지 않는다.                      |                                                    |                                                     |
| 컬렉션을 사용해도 제네릭으로 타입 정보를 알 수 있다. |                                                    |                                                     |

### @OneToMany

- 일대다 관계 매핑